<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
    <script src="//d3js.org/d3.v3.min.js"></script>
  </head>
  <body class="mixpanel-platform-body">
    <div id="date-picker"></div>
    <div id="query-times"></div>
    <div id="customers"></div>

    <style>
    body.mixpanel-platform-body {
      background:white;
    }
      .axis path,
      .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
      }
      .dot {
        stroke: none;
      }
      .threshold {
        stroke-width: 1;
        fill: none;
      }
      .customer {
        fill: #EEE;
      }
    </style>
    <script>
    
      var from_date = new Date().toISOString().slice(0,10);
      var to_date = new Date().toISOString().slice(0,10);
      $('#date-picker').MPDatepicker().on('change', function(event, dateRange) {
          from_date = dateRange.from.toISOString().slice(0,10);
          to_date = dateRange.to.toISOString().slice(0,10);
          refresh();
      });

      // thresholds are linear in the form y = mx + c
      // where x is the date-range adjusted tally, and y
      // is the query duration in seconds
      var thresholds = {
        'funnels': {m: 1.0e-9, c: 1.0},
        'segmentation': {m: 2.0e-9, c: 1.0},
        'retention': {m: 5e-9, c: 1.0}, 
        //'events/properties': {m: 0, c: 1.0}, 
        //'events/names': {m: 0, c: 1.0}, 
        //'events': {m: 0, c: 1.0},
        'timeout': {m: 0, c: 120.0},
      };
      var labels = _.keys(thresholds).sort();
      var qperfResults = []; // the results of all the queries.
      var qperfResultsByProject = {};
      var topProjects = []; // the people data for the top 500 projects
      MP.api.people({where: 'properties["rank"] <= 500'}).done(function(records) {
        topProjects = _.values(records.values().results);
      });
      
      function getQperfJQL() {
        return function main() {
            return join(Events({from_date: params.from_date, to_date: params.to_date, 
                                event_selectors:[{event: "API request"}]}), 
                        People())
                .filter(function(tup) { 
                  return tup.event != undefined
                  && tup.user != undefined
                  && tup.user.properties.rank <= 500
                  && tup.event.properties.num_days != undefined
                  && (params.project_id == undefined || tup.event.properties['project id'] == params.project_id)
                  && params.types.indexOf(tup.event.properties.endpoint) != -1
                  && Math.random() < 0.005; //sampling for debug
                })
                .map(function (tup){
                  var threshold = params.thresholds[tup.event.properties.endpoint];
                  var elapsed = tup.event.properties.elapsed / 1000;
                  var tally = tup.user.properties.events_tally * (tup.event.properties.num_days / 31.0);
                  var type_index = params.types.indexOf(tup.event.properties.endpoint);
                  var slow = elapsed > ((threshold.m * tally) + threshold.c) ? 1 : 0;
                  return [elapsed, tally, type_index, slow, tup.event.properties['project id']];
                });
            };
      }
      
      var margin = {top: 20, right: 20, bottom: 30, left: 60},
          width = 960 - margin.left - margin.right,
          height = 500 - margin.top - margin.bottom;
      
      function createQperfScatter(project_id) {
        var data = qperfResults;
        if (project_id != undefined) {
          data = _.filter(data, function (d) {return d[4] == project_id; });
        }
        
        var s = d3.scale.linear()
          .domain([0, 20000])
          .range([3, 0.2])
          .clamp(true);
          
        var x = d3.scale.log()
        .range([0, width]);
  
        var y = d3.scale.log()
        .range([height, 0]);
  
        var color = d3.scale.category10().domain(thresholds);
  
        var xAxis = d3.svg.axis()
        .ticks(10, d3.format(",.2s"))
        .scale(x)
        .orient("bottom");
  
        var yAxis = d3.svg.axis()
        .ticks(10, d3.format(",.2f"))
        .scale(y)
        .orient("left");
        
        var dot_size = s(data.length);
        x.domain(d3.extent(data, function(d) {return d[1];})).nice();
        y.domain([0.001, 150]).nice();
        
        d3.select("#query-times svg").remove();
        var query_times = d3.select("#query-times").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        
        query_times.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis)
          .append("text")
            .attr("class", "label")
            .attr("x", width)
            .attr("y", -6)
            .style("text-anchor", "end")
            .text("events queried (approx)");
          
        query_times.append("g")
            .attr("class", "y axis")
            .call(yAxis)
          .append("text")
            .attr("class", "label")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text("elapsed (sec)");
        
        query_times.selectAll(".dot")
            .data(data)
          .enter().append("circle")
            .attr("class", "dot")
            .attr("r", dot_size + "px")
            .attr("cx", function(d) { return x(d[1]); })
            .attr("cy", function(d) { return y(d[0]); })
            .style("fill", function(d) { return color(labels[d[2]]); });
        
        query_times.selectAll(".threshold")
          .data(labels)
        .enter().append("path")
          .attr("class", "threshold")
          .style("stroke", function(d) { return color(d); })
          .attr("d", function (d) {
            return "M" + _.map(_.range(x.range()[0], x.range()[1]), function (xx) {
              return xx + "," + y(thresholds[d].m * x.invert(xx) + thresholds[d].c);
            }).join("L");
          });
        
        var legend = query_times.selectAll(".legend")
          .data(color.domain())
        .enter().append("g")
          .attr("class", "legend")
          .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });
      
        legend.append("rect")
          .attr("x", width - 18)
          .attr("width", 18)
          .attr("height", 18)
          .style("fill", color);
      
        legend.append("text")
          .attr("x", width - 24)
          .attr("y", 9)
          .attr("dy", ".35em")
          .style("text-anchor", "end")
          .text(function(d) { return d; });
      }
      
      function createCustomerGrid() {
        
        function dsatScore(project_id) {
          var counts = qperfResultsByProject[project_id] || [];
          return counts.length == 0 ? -1 : _.filter(counts, function (q) {return q[4] == 1;}).length / counts.length;
        }
        
        var sorts = {
          'rank': function (r) {return r['$properties']['rank'];},
          'name': function (r) {return r['$properties']['name'];},
          'people_tally': function (r) {return r['$properties']['people_tally'];},
          'event_tally': function (r) {return r['$properties']['event_tally'];},
          'queries': function (r) {return (qperfResultsByProject[project_id] || []).length},
          'score': function (r) {return dsatScore(r['$distinct_id'])},
        }
        var data = _.sortBy(topProjects, sorts['rank']);
        
        d3.select("#customers svg").remove();
        var customers = d3.select("#customers").append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
        
        var dsatColor = d3.scale.linear().domain([0, 0.5 ,1]).range(["green", "yellow", "orange", "red", "black"]);

          
        var box = 20;
        var rows = Math.floor(width / box);
        customers.selectAll(".customer")
          .data(topProjects)
          .enter().append("rect")
          .attr("class", "customer")
          .attr("width", box * 0.9).attr("height", box * 0.9)
          .attr("x", function (d) {return (d['$properties']['rank'] % rows) * box;})
          .attr("y", function (d) {return Math.floor(d['$properties']['rank'] / rows) * box;})
          .style("fill", function (d) { 
            var score = dsatScore(d['$distinct_id']); 
            return score == -1 ? "#EEE" : dsatColor(score); 
          })
          .on("click", function (d) {createQperfScatter(d['$distinct_id']);});
      }
      
      function refresh(project_id) {
        MP.api.jql( getQperfJQL(), {
              from_date:from_date, 
              to_date:to_date,
              types: labels,
              thresholds: thresholds,
              project_id: project_id,
            }
        ).done( function(results) {
          qperfResults = results;
          qperfResultsByProject = _.reduce(qperfResults, function (memo, result) {
            memo[result[4]] = memo[result[4]] || [];
            memo[result[4]].push[result];
          });
          
          createQperfScatter();
          createCustomerGrid();
        });
      }
      
      
        
    </script>
  </body>
</html>
