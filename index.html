<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
    <script src="//d3js.org/d3.v3.min.js"></script>
  </head>
  <body class="mixpanel-platform-body">
    <div id="date-picker"></div>
    <div id="query-times"></div>
    <a id="showall" href="">show all</a>
    <br/>
    Filter by:
    <input id="filter" type=text/>
    <br/>
    Sort by:
    <ul id="sorts">
      <li><a href="">rank</a></li>
      <li><a href="">name</a></li>
      <li><a href="">people</a></li>
      <li><a href="">events</a></li>
      <li><a href="">queries</a></li>
      <li><a href="">score</a></li>
    </ul>
    
    <div id="customers"></div>

    <style>
      body.mixpanel-platform-body {
        background:white;
      }
      #sorts {
        display: inline;
      }
      #sorts li {
        display: inline;
        list-style-type: none;
        padding-right: 5px;
      }
      .axis path,
      .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
      }
      .axis .label {
        cursor: pointer;
      }
      .dot {
        stroke: none;
      }
      .threshold {
        stroke-width: 1;
        fill: none;
      }
      .customer text {
        fill: #000;
        pointer-events: none;
      }
    </style>
    <script>
      function trans(x, y) { return "translate(" + x + "," + y + ")"; }
      // thresholds are linear in the form y = mx + c
      // where x is the date-range adjusted tally, and y
      // is the query duration in seconds
      var thresholds = {
        'funnels': {m: 1.0e-9, c: 1.0},
        'segmentation': {m: 2.0e-9, c: 1.0},
        'retention': {m: 5e-9, c: 1.0}, 
        'events/properties': {m: 0, c: 1.0}, 
        'events/names': {m: 0, c: 1.0}, 
        'events': {m: 0, c: 1.0},
        'timeout': {m: 0, c: 120.0},
      };
      var labels = _.keys(thresholds).sort();
      var labelFilter = labels.slice(0);
      var color = d3.scale.category10().domain(labels);
      var qperfResults = []; // the results of all the queries.
      var qperfResultsByProject = {};
      var topProjects = []; // the people data for the top 500 projects
      var projectFilter = "";
      var from_date;
      var to_date;
      var xlog = true;
      var ylog = true;
      var currentProject;
      
      var margin = {top: 20, right: 20, bottom: 45, left: 60},
          width = 960 - margin.left - margin.right,
          height = 550 - margin.top - margin.bottom;
      createQperfScatter();
      createCustomerGrid();
      
      MP.api.people({where: 'properties["rank"] <= 500'}).done(function(records) {
        topProjects = _.values(records.values().results);
      });
      
      $('#date-picker').MPDatepicker().on('change', function(event, dateRange) {
          from_date = dateRange.from.toISOString().slice(0,10);
          to_date = dateRange.to.toISOString().slice(0,10);
          refresh();
      }).val({from: new Date(), to:new Date()});
      $('#showall').on('click', function(event) { 
        event.preventDefault();
        currentProject = undefined;
        updateQperfScatter();
      });
      $('#sorts li a').on('click', function(event) { 
        event.preventDefault();
        updateCustomerGrid(event.target.innerText);
      });
      
      $('#filter').on('input', function (event) {
        projectFilter = event.target.value;
        updateCustomerGrid(event.target.innerText);
      });
      
      function getQperfJQL() {
        return function main() {
            return join(Events({from_date: params.from_date, to_date: params.to_date, 
                                event_selectors:[{event: "API request"}]}), 
                        People())
                .filter(function(tup) { 
                  return tup.event != undefined
                  && tup.user != undefined
                  && tup.user.properties.rank <= 500
                  && tup.event.properties.num_days != undefined
                  && (params.project_id == undefined || tup.event.properties['project id'] == params.project_id)
                  && params.types.indexOf(tup.event.properties.endpoint) != -1
                  //&& Math.random() < 0.05; //sampling for debug
                })
                .map(function (tup){
                  var threshold = params.thresholds[tup.event.properties.endpoint];
                  var elapsed = tup.event.properties.elapsed / 1000;
                  var tally = tup.user.properties.events_tally * (tup.event.properties.num_days / 31.0);
                  var type_index = params.types.indexOf(tup.event.properties.endpoint);
                  var slow = elapsed > ((threshold.m * tally) + threshold.c) ? 1 : 0;
                  return [elapsed, tally, type_index, slow, tup.event.properties['project id']];
                });
            };
      }
      
      function getDstatHistoryJQL() {
        return function main() {
            return join(Events({from_date: params.from_date, to_date: params.to_date, 
                                event_selectors:[{event: "API request"}]}), 
                        People())
                .filter(function(tup) { 
                  return tup.event != undefined
                  && tup.user != undefined
                  && tup.event.properties.num_days != undefined
                  && (params.project_id == undefined || tup.event.properties['project id'] == params.project_id)
                  && params.types.indexOf(tup.event.properties.endpoint) != -1
                })
                .reduce(function (accumulators, tuples){
                  var result = {};
                  for (var a in accumulators) {
                    for (var k in accumulators[a]) {
                      result[k] = result[k] || [0,0];
                      result[k][0] += accumulators[a][k][0];
                      result[k][1] += accumulators[a][k][1];
                    }
                  }
                  for (var t in tuples) {
                    var tup = tuples[t];
                    var k = new Date(tup.event.time).toISOString().slice(0,10);
                    var threshold = params.thresholds[tup.event.properties.endpoint];
                    var elapsed = tup.event.properties.elapsed / 1000;
                    var tally = tup.user.properties.events_tally * (tup.event.properties.num_days / 31.0);
                    var slow = elapsed > ((threshold.m * tally) + threshold.c) ? 1 : 0;
                    result[k] = (result[k] || [0,0]);
                    result[k][slow] += 1;
                  }
                  return result;
                });
            };
      };

      function createQperfScatter() {
        var query_times = d3.select("#query-times").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", trans(margin.left, margin.top));

        query_times.append("g")
            .attr("class", "x axis")
            .attr("transform", trans(0, height))
          .append("text")
            .attr("class", "label")
            .attr("x", width/2)
            .attr("y", 40)
            .style("text-anchor", "middle")
            .text("events queried" + (xlog ? " (log)" : ""))
            .on("click", function () {xlog = !xlog; updateQperfScatter(currentProject);});
          
        query_times.append("g")
            .attr("class", "y axis")

          .append("text")
            .attr("class", "label")
            .attr("transform", "rotate(-90)")
            .attr("y", -50)
            .attr("x", -height/2)
            .style("text-anchor", "middle")
            .text("seconds elapsed" + (ylog ? " (log)" : ""))
            .on("click", function () {ylog = !ylog; updateQperfScatter(currentProject);});
            
        var legend = query_times.selectAll(".legend")
          .data(color.domain())
        .enter().append("g")
          .attr("class", "legend")
          .attr("transform", function(d, i) { return trans(0, i * 20); });
      
        legend.append("rect")
          .attr("x", width - 18)
          .attr("width", 18)
          .attr("height", 18)
          .style("fill", color);
      
        legend.append("text")
          .attr("x", width - 24)
          .attr("y", 9)
          .attr("dy", ".35em")
          .style("text-anchor", "end")
          .text(function(d) { return d; });
      }
      
      function updateQperfScatter() {
        var data = (currentProject == undefined) ? qperfResults : (qperfResultsByProject[currentProject] || []);
        
        var s = d3.scale.linear()
          .domain([0, 20000])
          .range([3, 0.5])
          .clamp(true);
        var dot_size = s(data.length)
          
        var x = d3.scale[xlog ? 'log' : 'linear']()
        .domain(d3.extent(data, function(d) {return d[1];})).nice()
        .range([0, width]);
  
        var y = d3.scale[ylog ? 'log' : 'linear']()
        .domain([0.001, 150]).nice()
        .range([height, 0]);
  
        var xAxis = d3.svg.axis()
        .ticks(10, d3.format(",.2s"))
        .scale(x)
        .orient("bottom");
  
        var yAxis = d3.svg.axis()
        .ticks(10, d3.format(",.2f"))
        .scale(y)
        .orient("left");
        
        var query_times = d3.select("#query-times svg g");
        query_times.select(".y.axis").call(yAxis);
        query_times.select(".x.axis").call(xAxis);
        
        query_times.selectAll(".dot").remove();
        query_times.selectAll(".dot")
            .data(data)
          .enter().append("circle")
            .attr("class", "dot")
            .attr("r", dot_size + "px")
            .attr("cx", function(d) { return x(d[1]); })
            .attr("cy", function(d) { return y(d[0]); })
            .style("fill", function(d) { return color(labels[d[2]]); });
        
        query_times.selectAll(".threshold").remove();
        query_times.selectAll(".threshold")
          .data(labels)
        .enter().append("path")
          .attr("class", "threshold")
          .style("stroke", function(d) { return color(d); })
          .attr("d", function (d) {
            return "M" + _.map(_.range(x.range()[0], x.range()[1]), function (xx) {
              return xx + "," + y(thresholds[d].m * x.invert(xx) + thresholds[d].c);
            }).join("L");
          });
      }
      
      function createCustomerGrid(sort) {
        d3.select("#customers").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", trans(margin.left, margin.top));
      }
      
      function updateCustomerGrid(sort) {
        function dsatScore(project_id) {
          var counts = qperfResultsByProject[project_id] || [];
          return counts.length == 0 ? -1 : _.filter(counts, function (q) {return q[3] == 1;}).length / counts.length;
        }
        
        sort = sort || 'rank';
        var sorts = {
          'rank': function (r) {return r['$properties']['rank'];},
          'name': function (r) {return r['$properties']['$name'];},
          'people': function (r) {return -r['$properties']['people_tally'];},
          'events': function (r) {return -r['$properties']['events_tally'];},
          'queries': function (r) {return -(qperfResultsByProject[r['$distinct_id']] || []).length},
          'score': function (r) {return -dsatScore(r['$distinct_id'])},
        }
        
        var projectFilterRegex = new RegExp(projectFilter, "gi");
        var data = _.filter(topProjects, function (d) {
          return projectFilter == ""
            || projectFilterRegex.test(d['$properties']['$name'])
            || projectFilterRegex.test(d['$distinct_id'] + "");
        });
        data = _.sortBy(data, sorts[sort]);

        var greenToRed = d3.scale.linear().domain([0, 0.33, 0.67, 1]).range(["green", "yellow", "orange", "red"]);
        function dsatColor(score) { return score == -1 ? "#CCC" : greenToRed(score) }
        
        var box = [60, 20];
        var cols = Math.floor(width / box[0]);
        var rows = Math.ceil(data.length / cols);
        d3.select("#customers svg").attr('height', rows * box[1] + margin.top + margin.bottom);
        
        var tiles = d3.select("#customers svg g").selectAll(".customer")
          .data(data, function (d) {return d['$distinct_id'];});
          
        var tile = tiles.enter()
          .append("g")
          .attr("class", "customer")
          .on("click", function (d) {currentProject = d['$distinct_id']; updateQperfScatter();})
          .on('mouseover', function (d) {})
          .on('mouseout', function (d) {});
        tile.append("rect")
          .attr("width", box[0] - 2)
          .attr("height", box[1] - 2);
        tile.append("text")
          .attr("transform", trans(2,11))
          .text(function (d) { return d['$properties']['$name']; });
          
        // Enter + Update
        tiles.transition().attr("transform", function (d,i){
          return trans((i % cols) * box[0], Math.floor(i / cols) * box[1]);
        });
        tiles.select("rect").style("fill", function (d) { return dsatColor(dsatScore(d['$distinct_id']));});
        
        tiles.exit().remove();
      }
      
      function refresh(project_id) {
        MP.api.jql( getQperfJQL(), {
          from_date:from_date, 
          to_date:to_date,
          types: labels,
          thresholds: thresholds,
          project_id: project_id,
        }).done( function(results) {
          qperfResults = _.filter(results, function () { return Math.random() < 0.01 });
          qperfResultsByProject = _.reduce(results, function (memo, result) {
            memo[result[4]] = memo[result[4]] || [];
            memo[result[4]].push(result); 
            return memo;
          }, {});
          updateQperfScatter();
          updateCustomerGrid();
        });
      }
    </script>
  </body>
</html>
