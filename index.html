<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
    <script src="//d3js.org/d3.v3.min.js"></script>
  </head>
  <body class="mixpanel-platform-body">
    <style>
      .axis path,
      .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
      }
      
      .dot {
        stroke: #000;
      }
    </style>
    <script>
        var margin = {top: 20, right: 20, bottom: 30, left: 100},
            width = 960 - margin.left - margin.right,
            height = 500 - margin.top - margin.bottom;

            var x = d3.scale.log()
            .range([0, width]);

            var y = d3.scale.log()
            .range([height, 0]);

            var color = d3.scale.category10();

            var xAxis = d3.svg.axis()
            .scale(x)
            .orient("bottom");

            var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left");

            var svg = d3.select("body").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
            
            MP.api.jql(
                function main() {
                    return join(Events({from_date: '2016-05-08', to_date: '2016-05-08', 
                                        event_selectors:[{event: "API request"}]}), 
                                People())
                        .filter(function(tup) { 
                          return tup.event != undefined && 
                            tup.user != undefined && 
                            tup.user.properties.rank <= 100;
                        })
                        .map(function (tup){ 
                          if (tup.event == undefined || tup.user == undefined) {
                            return [0,0,'none']
                          }
                          return [tup.event.properties.elapsed, 
                            tup.user.properties.events_tally, 
                            tup.event.properties.endpoint
                            ]; 
                        });
                }
            ).done(
                function(results) {
                  //results = results.map(function(r) {return {'x':r.value, 'y':r.value, 't':r.key[0]};});
                  
                  x.domain(d3.extent(results, function(d) {return d[0];})).nice();
                  y.domain(d3.extent(results, function(d) {return d[1];})).nice();
                  
                  svg.append("g")
                      .attr("class", "x axis")
                      .attr("transform", "translate(0," + height + ")")
                      .call(xAxis)
                    .append("text")
                      .attr("class", "label")
                      .attr("x", width)
                      .attr("y", -6)
                      .style("text-anchor", "end")
                      .text("elapsed");
                    
                  svg.append("g")
                      .attr("class", "y axis")
                      .call(yAxis)
                    .append("text")
                      .attr("class", "label")
                      .attr("transform", "rotate(-90)")
                      .attr("y", 6)
                      .attr("dy", ".71em")
                      .style("text-anchor", "end")
                      .text("event tally");
                    
                  svg.selectAll(".dot")
                      .data(results)
                    .enter().append("circle")
                      .attr("class", "dot")
                      .attr("r", 3.5)
                      .attr("cx", function(d) { return x(d[0]); })
                      .attr("cy", function(d) { return y(d[1]); })
                      .style("fill", function(d) { return color(d[2]); });
                  
                  var legend = svg.selectAll(".legend")
                      .data(color.domain())
                    .enter().append("g")
                      .attr("class", "legend")
                      .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });
                
                  legend.append("rect")
                      .attr("x", width - 18)
                      .attr("width", 18)
                      .attr("height", 18)
                      .style("fill", color);
                
                  legend.append("text")
                      .attr("x", width - 24)
                      .attr("y", 9)
                      .attr("dy", ".35em")
                      .style("text-anchor", "end")
                      .text(function(d) { return d; });
                }
            );

    </script>
  </body>
</html>
